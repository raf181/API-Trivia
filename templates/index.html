{% extends "base.html" %}

{% block title %}Home - Flask Trivia Dashboard{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="jumbotron bg-primary text-white p-5 rounded">
            <h1 class="display-4">
                <i class="bi bi-lightbulb-fill"></i> Welcome to Trivia Dashboard
            </h1>
            <p class="lead">
                Test your knowledge with thousands of questions from the Open Trivia Database!
            </p>
            <hr class="my-4 bg-white">
            <p>
                Customize your trivia experience by selecting category, difficulty, and question type.
                Then jump into Play mode and challenge yourself!
            </p>
            <a class="btn btn-light btn-lg" href="#play-section" role="button">
                <i class="bi bi-play-circle-fill"></i> Start Playing
            </a>
        </div>
    </div>
</div>

<!-- API Explorer Section -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0">
                    <i class="bi bi-gear-fill"></i> API Explorer
                </h3>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Preview the raw JSON response from OpenTDB before starting a game.
                </p>
                
                <form id="apiPreviewForm">
                    <div class="row g-3">
                        <!-- Amount -->
                        <div class="col-md-6 col-lg-3">
                            <label for="preview_amount" class="form-label">Number of Questions</label>
                            <input type="number" class="form-control" id="preview_amount" 
                                   name="amount" value="10" min="1" max="50">
                        </div>
                        
                        <!-- Category -->
                        <div class="col-md-6 col-lg-3">
                            <label for="preview_category" class="form-label">Category</label>
                            <select class="form-select" id="preview_category" name="category">
                                <option value="">Any Category</option>
                                {% for cat in opentdb_categories %}
                                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Difficulty -->
                        <div class="col-md-6 col-lg-3">
                            <label for="preview_difficulty" class="form-label">Difficulty</label>
                            <select class="form-select" id="preview_difficulty" name="difficulty">
                                <option value="">Any Difficulty</option>
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        
                        <!-- Type -->
                        <div class="col-md-6 col-lg-3">
                            <label for="preview_type" class="form-label">Type</label>
                            <select class="form-select" id="preview_type" name="type">
                                <option value="">Any Type</option>
                                <option value="multiple">Multiple Choice</option>
                                <option value="boolean">True/False</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="submit" class="btn btn-info text-white">
                            <i class="bi bi-search"></i> Preview JSON
                        </button>
                        <span id="loadingSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </span>
                    </div>
                </form>
                
                <!-- API Status Card -->
                <div id="apiStatusCard" class="card mt-3 d-none">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">API Status</h6>
                            <span id="apiLatency" class="badge bg-secondary"></span>
                        </div>
                        <pre id="apiResponse" class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Play Section -->
<div class="row mb-5" id="play-section">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">
                    <i class="bi bi-play-circle-fill"></i> Start Game
                </h3>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Configure your trivia game and start playing!
                </p>
                
                <form method="POST" action="{{ url_for('play') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="row g-3">
                        <!-- Amount -->
                        <div class="col-md-6 col-lg-3">
                            <label for="play_amount" class="form-label">Number of Questions</label>
                            <input type="number" class="form-control" id="play_amount" 
                                   name="amount" value="10" min="1" max="50" required>
                            <div class="form-text">1-50 questions</div>
                        </div>
                        
                        <!-- Category -->
                        <div class="col-md-6 col-lg-3">
                            <label for="play_category" class="form-label">Category</label>
                            <select class="form-select" id="play_category" name="category">
                                <option value="">Any Category</option>
                                {% for cat in opentdb_categories %}
                                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Difficulty -->
                        <div class="col-md-6 col-lg-3">
                            <label for="play_difficulty" class="form-label">Difficulty</label>
                            <select class="form-select" id="play_difficulty" name="difficulty">
                                <option value="">Any Difficulty</option>
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        
                        <!-- Type -->
                        <div class="col-md-6 col-lg-3">
                            <label for="play_type" class="form-label">Type</label>
                            <select class="form-select" id="play_type" name="type">
                                <option value="">Any Type</option>
                                <option value="multiple">Multiple Choice</option>
                                <option value="boolean">True/False</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-play-circle-fill"></i> Start Game
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row">
    <div class="col-md-4 mb-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <i class="bi bi-question-circle display-4 text-primary"></i>
                <h5 class="card-title mt-3">4,000+ Questions</h5>
                <p class="card-text text-muted">From multiple categories</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <i class="bi bi-trophy display-4 text-warning"></i>
                <h5 class="card-title mt-3">Leaderboard</h5>
                <p class="card-text text-muted">Compete with others</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <i class="bi bi-graph-up display-4 text-success"></i>
                <h5 class="card-title mt-3">Track Progress</h5>
                <p class="card-text text-muted">Monitor your scores</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('apiPreviewForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const spinner = document.getElementById('loadingSpinner');
    const statusCard = document.getElementById('apiStatusCard');
    const responseDiv = document.getElementById('apiResponse');
    const latencySpan = document.getElementById('apiLatency');
    
    // Show spinner
    spinner.classList.remove('d-none');
    statusCard.classList.add('d-none');
    
    // Get form data
    const formData = new FormData(e.target);
    const params = new URLSearchParams();
    
    for (const [key, value] of formData) {
        if (value) params.append(key, value);
    }
    
    try {
        const response = await fetch(`/api-preview?${params.toString()}`);
        const data = await response.json();
        
        // Hide spinner, show result
        spinner.classList.add('d-none');
        statusCard.classList.remove('d-none');
        
        // Display latency
        latencySpan.textContent = `${data.latency_ms}ms ${data.cached ? '(cached)' : ''}`;
        latencySpan.className = data.success ? 'badge bg-success' : 'badge bg-danger';
        
        // Display JSON
        responseDiv.textContent = JSON.stringify(data.data, null, 2);
        
    } catch (error) {
        spinner.classList.add('d-none');
        statusCard.classList.remove('d-none');
        
        latencySpan.textContent = 'Error';
        latencySpan.className = 'badge bg-danger';
        
        responseDiv.textContent = `Error: ${error.message}`;
    }
});
</script>
{% endblock %}
